# 权限系统使用说明

## 📋 功能概述

系统实现了基于角色的权限管理(RBAC),支持**管理员**和**团长**两种角色,不同角色拥有不同的功能权限。

---

## 👥 角色说明

### 1. 管理员 (admin)
**定位**: 平台运营人员,负责全局业务管理

**权限**:
- ✅ 数据看板 - 查看全平台业务数据
- ✅ 订单管理 - 管理所有团长的订单
- ✅ 团长管理 - 管理团长信息、审核团长申请
- ✅ 佣金管理 - 审核提现申请、查看佣金统计

**登录信息**:
```
用户名: admin
密码: 123456
```

### 2. 团长 (leader)
**定位**: 社区"销售代理人"和"自提点负责人"

**权限**:
- ✅ 个人中心 - 查看收益统计、业绩数据
- ✅ 我的订单 - 管理自己社区的订单
- ✅ 提现申请 - 申请佣金提现

**登录信息**:
```
用户名: leader
密码: 123456
```

---

## 🔐 权限控制实现

### 1. 用户状态管理 (`stores/user.ts`)

使用Pinia管理用户登录状态:

```typescript
export interface UserInfo {
  id: number
  username: string
  nickname: string
  role: 'admin' | 'leader'  // 角色标识
  leaderId?: number         // 团长ID(仅团长有)
  commissionRate?: number   // 佣金比例(仅团长有)
}
```

**核心方法**:
- `login()` - 登录并保存用户信息到localStorage
- `logout()` - 退出登录并清除状态
- `restoreLogin()` - 从localStorage恢复登录状态
- `isAdmin()` - 判断是否为管理员
- `isLeader()` - 判断是否为团长

### 2. 路由守卫 (`router/index.ts`)

**功能**:
- 未登录用户访问需要登录的页面 → 跳转到登录页
- 已登录用户访问登录页 → 跳转到对应角色的首页
- 角色权限验证 → 无权限时跳转到对应首页

**路由配置示例**:
```typescript
{
  path: 'dashboard',
  meta: { title: '数据看板', roles: ['admin'] }  // 仅管理员可访问
},
{
  path: 'leader-center',
  meta: { title: '个人中心', roles: ['leader'] }  // 仅团长可访问
}
```

### 3. 布局组件 (`components/Layout/index.vue`)

**动态菜单**:
```vue
<!-- 管理员菜单 -->
<template v-if="userStore.isAdmin()">
  <el-menu-item index="/dashboard">数据看板</el-menu-item>
  <el-menu-item index="/order">订单管理</el-menu-item>
  ...
</template>

<!-- 团长菜单 -->
<template v-if="userStore.isLeader()">
  <el-menu-item index="/leader-center">个人中心</el-menu-item>
  <el-menu-item index="/my-orders">我的订单</el-menu-item>
</template>
```

---

## 📊 页面功能详解

### 管理员页面

#### 1. 数据看板 (`/dashboard`)
- 今日订单、销售额、待审核提现、活跃团长统计
- 订单趋势图表(近7天/30天)
- 销售额分布饼图
- 团长业绩排行榜

#### 2. 订单管理 (`/order`)
- 多条件搜索(日期、状态、团长、关键词)
- 订单列表展示(所有团长的订单)
- 导出配送清单和订单数据
- 分页查询

#### 3. 团长管理 (`/leader`)
- 团长信息CRUD
- 启用/禁用团长状态
- 查看团长累计订单、佣金、余额

#### 4. 佣金管理 (`/commission`)
- 平台佣金统计(今日/本月/累计)
- 收益趋势图表
- 提现申请审核(通过/拒绝)

### 团长页面

#### 1. 个人中心 (`/leader-center`)
**佣金统计卡片**:
- 今日收益: ¥186.5
- 本月收益: ¥3,280.0
- 累计收益: ¥15,680.5
- 可提现余额: ¥8,500.0 (可直接申请提现)

**订单趋势图表**:
- 支持近7天/30天数据切换
- 订单数量(柱状图) + 销售额(折线图)双轴展示

**业绩统计**:
- 今日订单: 15单
- 本月订单: 128单
- 累计订单: 856单
- 佣金比例: 12%
- 服务社区: 阳光小区
- 客户数量: 156人

**最近订单**:
- 显示最近5条订单
- 查看订单详情
- 快速跳转到"我的订单"

#### 2. 我的订单 (`/my-orders`)
**搜索功能**:
- 按订单状态筛选
- 按时间范围筛选
- 按关键词搜索(订单号/客户姓名)

**订单列表**:
- 显示客户姓名、联系电话
- 显示订单金额和自己的佣金
- 订单状态(待确认/已确认/配送中/已完成/已取消)
- 查看订单详情(商品明细)
- 配送中订单可"确认收货"

**订单详情**:
- 订单基本信息
- 客户信息(姓名、电话、地址)
- 商品明细列表(商品名称、单价、数量、小计)

---

## 🔄 登录流程

```
1. 用户输入用户名和密码
   ↓
2. 系统验证账号密码
   ↓
3. 登录成功,保存用户信息到store和localStorage
   ↓
4. 根据角色跳转:
   - admin → /dashboard (数据看板)
   - leader → /leader-center (个人中心)
```

---

## 💻 技术实现要点

### 1. 状态持久化
```typescript
// 登录时保存到localStorage
localStorage.setItem('userInfo', JSON.stringify(user))
localStorage.setItem('token', tokenStr)

// 刷新页面时自动恢复
const restoreLogin = () => {
  const savedUser = localStorage.getItem('userInfo')
  const savedToken = localStorage.getItem('token')
  if (savedUser && savedToken) {
    userInfo.value = JSON.parse(savedUser)
    token.value = savedToken
  }
}
```

### 2. 路由守卫
```typescript
router.beforeEach((to, from, next) => {
  // 1. 恢复登录状态
  if (!userStore.userInfo) {
    userStore.restoreLogin()
  }

  // 2. 登录页判断
  if (to.path === '/login' && userStore.userInfo) {
    next(userStore.isAdmin() ? '/dashboard' : '/leader-center')
    return
  }

  // 3. 权限验证
  const roles = to.meta.roles
  if (roles && !roles.includes(userStore.userInfo.role)) {
    next(userStore.isAdmin() ? '/dashboard' : '/leader-center')
    return
  }

  next()
})
```

### 3. 组件权限控制
```vue
<template>
  <!-- 管理员才能看到的按钮 -->
  <el-button v-if="userStore.isAdmin()" type="primary">
    审核
  </el-button>

  <!-- 团长才能看到的按钮 -->
  <el-button v-if="userStore.isLeader()" type="success">
    申请提现
  </el-button>
</template>
```

---

## 📝 数据说明

### 模拟用户数据 (`Login/index.vue`)

```typescript
const mockUsers = {
  admin: {
    id: 1,
    username: 'admin',
    nickname: '系统管理员',
    role: 'admin',
    password: '123456'
  },
  leader: {
    id: 2,
    username: 'leader',
    nickname: '张阿姨',
    role: 'leader',
    password: '123456',
    leaderId: 1,
    commissionRate: 0.12  // 12%佣金比例
  }
}
```

### 团长模拟数据特点

1. **数据范围**: 仅显示团长自己的数据
   - 个人中心: 自己的收益、订单统计
   - 我的订单: 只显示自己社区的订单

2. **订单归属**: 订单关联到具体团长
   - 客户姓名: 王女士、李先生、赵女士等
   - 配送地址: 阳光小区X栋X单元
   - 佣金计算: 订单金额 × 佣金比例(12%)

3. **状态流转**:
   ```
   待确认(0) → 已确认(1) → 配送中(2) → 已完成(3)
                                    ↓
                                 已取消(4)
   ```

---

## 🚀 快速测试

### 测试管理员功能
1. 使用 `admin / 123456` 登录
2. 查看数据看板 - 全平台数据统计
3. 进入订单管理 - 查看所有订单
4. 进入团长管理 - 管理团长信息
5. 进入佣金管理 - 审核提现申请

### 测试团长功能
1. 退出登录
2. 使用 `leader / 123456` 登录
3. 查看个人中心 - 收益统计和业绩数据
4. 点击"申请提现" - 填写提现信息
5. 进入我的订单 - 查看订单列表
6. 点击"查看详情" - 查看订单详细信息
7. 对"配送中"订单点击"确认收货"

---

## 📌 后续扩展

1. **增加角色**: 可添加供应商、财务等角色
2. **细粒度权限**: 基于按钮级、字段级的权限控制
3. **动态权限**: 从后端API获取用户权限配置
4. **权限缓存**: 使用Pinia持久化插件缓存权限
5. **操作日志**: 记录关键操作(登录、审核、提现等)

---

## 🎯 总结

- ✅ 实现了管理员和团长两种角色
- ✅ 登录时自动根据角色跳转不同页面
- ✅ 不同角色显示不同的菜单和功能
- ✅ 路由守卫自动验证权限
- ✅ 状态持久化,刷新页面不丢失登录状态
- ✅ 团长可以查看自己的收益和订单
- ✅ 管理员可以查看全平台数据和审核提现

**学号**: 2022005566  
**学生**: 张建亮  
**项目**: 社区团购团长分销与订单汇总系统
