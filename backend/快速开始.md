# 后端快速开始指南

## ✅ 已完成的工作

### 1. 项目结构搭建完成
```
backend/
├── src/
│   ├── config/          ✅ 配置文件（数据库、JWT、应用）
│   ├── models/          ✅ 8张表的数据模型
│   ├── controllers/     ✅ 认证控制器
│   ├── middleware/      ✅ 4个中间件（认证、权限、错误、验证）
│   ├── routes/          ✅ 认证路由
│   ├── utils/           ✅ 工具函数（响应、日志、辅助）
│   ├── scripts/         ✅ 数据库初始化和数据填充脚本
│   └── app.js           ✅ 应用入口
├── logs/                ✅ 日志目录
├── .env                 ✅ 环境变量配置
├── package.json         ✅ 依赖配置
└── README.md            ✅ 项目文档
```

### 2. 核心功能已实现
- ✅ **用户认证**: 登录、注册、获取用户信息
- ✅ **JWT 认证中间件**: 保护需要登录的路由
- ✅ **角色权限中间件**: 区分管理员和团长权限
- ✅ **8张数据表模型**: User, Community, Leader, Product, Order, OrderItem, Commission, Withdrawal
- ✅ **数据关联关系**: 完整的外键关联
- ✅ **测试数据生成**: 自动生成10个团长、10种商品、350条订单

---

## 🚀 启动步骤

### 第1步：安装依赖

```bash
cd backend
npm install
```

**注意**: 如果使用 pnpm，需要在项目根目录运行：
```bash
pnpm install -w
```

### 第2步：配置数据库

1. 确保 MySQL 已启动
2. 创建数据库（可选，初始化脚本会自动创建表）：
```sql
CREATE DATABASE community_group_buying CHARACTER SET utf8mb4;
```

3. 修改 `backend/.env` 文件中的数据库配置：
```
DB_HOST=localhost
DB_PORT=3306
DB_NAME=community_group_buying
DB_USER=root
DB_PASSWORD=你的MySQL密码
```

### 第3步：初始化数据库

```bash
cd backend

# 创建所有表
npm run init-db

# 填充测试数据（10个团长、10种商品、350条订单）
npm run seed
```

**测试账号：**
- 管理员: `admin` / `admin123`
- 团长: `leader1-leader10` / `leader123`

### 第4步：启动服务器

```bash
# 开发模式（自动重启）
npm run dev

# 生产模式
npm start
```

服务器运行在: `http://localhost:3000`

### 第5步：测试 API

使用 Postman 或 curl 测试登录接口：

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

响应示例：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "id": 1,
      "username": "admin",
      "role": "admin",
      "realName": "系统管理员"
    }
  }
}
```

---

## 📊 测试数据说明

### 生成的数据：
- ✅ 1个管理员用户
- ✅ 10个团长用户（分布在5个社区）
- ✅ 10种商品（8种上架，2种下架）
- ✅ 5个社区
- ✅ 350条订单（最近7天，每天50条）
  - 前5天的订单：已完成（已结算佣金）
  - 昨天的订单：待自提
  - 今天的订单：待成团
- ✅ 自动生成的佣金记录和统计数据

### 商品数据：
1. 新鲜草莓 - ¥29.90 (佣金12%)
2. 有机蔬菜包 - ¥49.90 (佣金15%)
3. 进口车厘子 - ¥89.00 (佣金10%)
4. 鲜牛奶 - ¥48.80 (佣金12%)
5. 土鸡蛋 - ¥32.90 (佣金15%)
6. 新鲜蓝莓 - ¥45.00 (佣金12%)
7. 五常大米 - ¥68.00 (佣金10%)
8. 新鲜猕猴桃 - ¥36.90 (佣金12%)
9. 有机西红柿 - ¥28.50 (已下架)
10. 精品牛肉 - ¥118.00 (已下架)

---

## 🔧 下一步开发任务

### 1. 商品管理 API（优先）
- `GET /api/products` - 商品列表
- `POST /api/products` - 创建商品
- `PUT /api/products/:id` - 更新商品
- `DELETE /api/products/:id` - 删除商品
- `PATCH /api/products/:id/status` - 上下架

### 2. 订单管理 API
- `GET /api/orders` - 订单列表
- `GET /api/orders/:id` - 订单详情
- `PUT /api/orders/:id/status` - 更新订单状态
- `GET /api/orders/export` - 导出配送清单（Excel）
- `POST /api/orders/:id/verify` - 核销订单

### 3. 团长管理 API
- `GET /api/leaders` - 团长列表
- `POST /api/leaders` - 创建团长
- `PUT /api/leaders/:id` - 更新团长
- `DELETE /api/leaders/:id` - 删除团长
- `GET /api/leaders/:id/stats` - 团长统计

### 4. 佣金管理 API
- `GET /api/commissions` - 佣金记录
- `GET /api/commissions/stats` - 佣金统计

### 5. 提现管理 API
- `GET /api/withdrawals` - 提现列表
- `POST /api/withdrawals` - 申请提现
- `PUT /api/withdrawals/:id/approve` - 审核通过
- `PUT /api/withdrawals/:id/reject` - 审核拒绝

---

## 📝 常见问题

### Q: 如何重新生成测试数据？

```bash
npm run init-db  # 清空并重建所有表
npm run seed     # 重新生成测试数据
```

### Q: 如何修改端口号？

修改 `backend/.env` 文件：
```
PORT=3001
```

### Q: JWT token 过期时间是多久？

默认 7 天，可在 `.env` 中修改：
```
JWT_EXPIRES_IN=30d  # 30天
```

### Q: 如何查看 SQL 查询日志？

开发模式下，控制台会自动输出所有 SQL 语句。

### Q: 数据库表结构修改后如何更新？

```bash
# 方式1: 自动同步（开发环境）
# 启动服务器时会自动执行 sync({ alter: true })

# 方式2: 手动重建（会清空数据）
npm run init-db
npm run seed
```

---

## 🎯 前后端联调准备

1. ✅ 后端服务运行在 `http://localhost:3000`
2. ✅ 前端服务运行在 `http://localhost:5173`
3. ✅ CORS 已配置允许跨域
4. ✅ 统一响应格式：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": { ... }
}
```

5. ✅ 前端需要修改 API 基础URL：
```typescript
// frontend/src/api/request.ts
const API_BASE_URL = 'http://localhost:3000/api'
```

---

## 📌 开发建议

1. **优先完成商品管理 API**，这样前端商品管理页面可以立即联调
2. **使用 Postman 测试**每个接口，确保逻辑正确
3. **参考 authController.js** 的写法，保持代码风格一致
4. **注意安全性**：
   - 所有数据库查询使用 Sequelize（自动防SQL注入）
   - 动态字段（orderBy）必须白名单验证
   - 敏感操作需要权限验证

---

需要我继续实现商品管理 API 吗？
